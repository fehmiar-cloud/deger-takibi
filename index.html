<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Finans Dashboard v5</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:-apple-system,Arial;background:#f3f4f6;margin:20px}
h1{margin-bottom:10px}
.section{background:#fff;padding:16px;border-radius:14px;margin-bottom:18px}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.kpi{background:#fafafa;padding:12px;border-radius:10px}
.pos{color:#16a34a;font-weight:600}
.neg{color:#dc2626;font-weight:600}
.arrow{font-size:14px;margin-left:4px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:left}
.scroll{max-height:220px;overflow-y:auto}
button{padding:6px 10px;margin:4px}
input,select{padding:5px;margin:4px}
.actions span{cursor:pointer;margin-right:6px}
</style>
</head>

<body>

<h1>ðŸ“Š Finans Dashboard</h1>

<div class="kpis">
  <div class="kpi"><b>Son DeÄŸer</b><div id="kpiLast">-</div></div>
  <div class="kpi"><b>GÃ¼nlÃ¼k %</b><div id="kpiDaily">-</div></div>
  <div class="kpi"><b>7 GÃ¼n %</b><div id="kpiWeekly">-</div></div>
  <div class="kpi"><b>AylÄ±k %</b><div id="kpiMonthly">-</div></div>
  <div class="kpi"><b>Toplam Nakit Ã‡Ä±kÄ±ÅŸÄ±</b><div id="kpiCash">-</div></div>
</div>

<div class="section">
<h3>ðŸ“¥ GÃ¼nlÃ¼k DeÄŸer</h3>
<input type="date" id="vDate">
<input type="number" id="vValue" placeholder="DeÄŸer">
<button onclick="addValue()">Ekle</button>
<input type="file" onchange="importCSV(event,'values')">
<button onclick="exportCSV(values,'gunluk_deger')">Export</button>
<div class="scroll">
<table id="valueTable"></table>
</div>
</div>

<div class="section">
<h3>ðŸ’¸ Nakit Ã‡Ä±kÄ±ÅŸÄ± (KayÄ±p DeÄŸil)</h3>
<input type="date" id="cDate">
<input type="number" id="cAmount" placeholder="Tutar">
<input type="text" id="cNote" placeholder="AÃ§Ä±klama">
<button onclick="addCash()">Ekle</button>
<input type="file" onchange="importCSV(event,'cash')">
<button onclick="exportCSV(cash,'nakit_cikis')">Export</button>
<div class="scroll">
<table id="cashTable"></table>
</div>
</div>

<div class="section">
<h3>ðŸ“… Tarih AralÄ±ÄŸÄ± Performans</h3>
<input type="date" id="from">
<input type="date" id="to">
<button onclick="rangeCalc()">Hesapla</button>
<div id="rangeResult"></div>
</div>

<div class="section">
<canvas id="chart"></canvas>
</div>

<script>
const fmt=n=>Number(n).toLocaleString("tr-TR");
let values=JSON.parse(localStorage.getItem("values"))||[];
let cash=JSON.parse(localStorage.getItem("cash"))||[];

function save(){localStorage.setItem("values",JSON.stringify(values));
localStorage.setItem("cash",JSON.stringify(cash));update();}

function addValue(){values.push({date:vDate.value,value:+vValue.value});save();}
function addCash(){cash.push({date:cDate.value,amount:+cAmount.value,note:cNote.value});save();}

function del(arr,i){if(confirm("Silinsin mi?")){arr.splice(i,1);save();}}
function editVal(i){let v=prompt("Yeni deÄŸer",values[i].value);if(v){values[i].value=+v;save();}}
function editCash(i){let v=prompt("Yeni tutar",cash[i].amount);if(v){cash[i].amount=+v;save();}}

function pct(a,b){return ((b-a)/a)*100;}
function arrow(p){return p>=0?'<span class="pos">â–²</span>':'<span class="neg">â–¼</span>';}
function col(p){return p>=0?'pos':'neg';}

function kpis(){
if(values.length<2)return;
let last=values.at(-1).value;
let prev=values.at(-2).value;
let d=pct(prev,last);
kpiLast.innerText=fmt(last);
kpiDaily.innerHTML=`<span class="${col(d)}">${d.toFixed(2)}% ${arrow(d)}</span>`;

let now=new Date(values.at(-1).date);
let w=values.find(v=>(now-new Date(v.date))/(86400000)>=6);
if(w){
let wp=pct(w.value,last);
kpiWeekly.innerHTML=`<span class="${col(wp)}">${wp.toFixed(2)}% ${arrow(wp)}</span>`;
}

let m=values.find(v=>new Date(v.date).getMonth()!=now.getMonth());
if(m){
let mp=pct(m.value,last);
kpiMonthly.innerHTML=`<span class="${col(mp)}">${mp.toFixed(2)}% ${arrow(mp)}</span>`;
}

kpiCash.innerText=fmt(cash.reduce((a,b)=>a+b.amount,0));
}

let ch;
function chartRender(data){
if(ch)ch.destroy();
ch=new Chart(chart,{type:"bar",
data:{labels:data.map(v=>v.date),
datasets:[{data:data.map(v=>v.value)}]}});
}

function rangeCalc(){
let f=new Date(from.value),t=new Date(to.value);
let r=values.filter(v=>new Date(v.date)>=f&&new Date(v.date)<=t);
if(r.length<2)return;
let p=pct(r[0].value,r.at(-1).value);
let tl=r.at(-1).value-r[0].value;
rangeResult.innerHTML=
`<b>${p.toFixed(2)}%</b> (${fmt(tl)} TL)`;
chartRender(r);
}

function tables(){
valueTable.innerHTML="<tr><th>Tarih</th><th>DeÄŸer</th><th></th></tr>"+
values.map((v,i)=>`<tr><td>${v.date}</td><td>${fmt(v.value)}</td>
<td class="actions"><span onclick="editVal(${i})">âœŽ</span><span onclick="del(values,${i})">âœ–</span></td></tr>`).join("");

cashTable.innerHTML="<tr><th>Tarih</th><th>Tutar</th><th>AÃ§Ä±klama</th><th></th></tr>"+
cash.map((c,i)=>`<tr><td>${c.date}</td><td>${fmt(c.amount)}</td><td>${c.note}</td>
<td class="actions"><span onclick="editCash(${i})">âœŽ</span><span onclick="del(cash,${i})">âœ–</span></td></tr>`).join("");
}

function exportCSV(data,name){
let csv=Object.keys(data[0]).join(",")+"\n"+data.map(o=>Object.values(o).join(",")).join("\n");
let a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
a.download=name+".csv";a.click();
}

function importCSV(e,type){
let f=e.target.files[0];
let r=new FileReader();
r.onload=()=>{
let l=r.result.split("\n").slice(1);
l.forEach(x=>{
let p=x.split(",");
if(type=="values")values.push({date:p[0],value:+p[1]});
else cash.push({date:p[0],amount:+p[1],note:p[2]||""});
});
save();
};
r.readAsText(f);
}

function update(){tables();kpis();chartRender(values);}
update();
</script>
</body>
</html>
