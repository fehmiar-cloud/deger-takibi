<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finans Dashboard v6</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px }
    .container { max-width:1200px; margin:auto }
    h1 { margin-bottom:10px }
    .kpi-box { display:grid; grid-template-columns: repeat(4,1fr); gap:15px; margin-bottom:20px }
    .kpi { background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1) }
    .kpi span { display:block; font-size:14px; color:#666 }
    .kpi strong { font-size:20px }
    .positive { color:green }
    .negative { color:red }
    .controls { background:#fff; padding:15px; border-radius:10px; margin-bottom:20px }
    .controls select, .controls input, .controls button { margin-right:10px; padding:6px }
    canvas { background:#fff; padding:15px; border-radius:10px }
    .summary { background:#fff; margin-top:15px; padding:15px; border-radius:10px }
  </style>
</head>
<body>
<div class="container">
  <h1>Finans Dashboard v6</h1>

  <!-- ÜST TARİH HESAPLAMA -->
  <div class="controls">
    <strong>Genel Performans Hesaplama:</strong><br><br>
    <select id="presetRange">
      <option value="7">Son 7 Gün</option>
      <option value="30">Son 30 Gün</option>
      <option value="365">Son 1 Yıl</option>
      <option value="custom">Özel</option>
    </select>
    <input type="date" id="topStart" />
    <input type="date" id="topEnd" />
    <button onclick="calculateTopRange()">Hesapla</button>
  </div>

  <div class="kpi-box">
    <div class="kpi"><span>Son Değer</span><strong id="lastValue">-</strong></div>
    <div class="kpi"><span>Değişim (TL)</span><strong id="rangeDiff">-</strong></div>
    <div class="kpi"><span>Değişim (%)</span><strong id="rangePct">-</strong></div>
    <div class="kpi"><span>Nakit Çıkışı</span><strong id="rangeCash">-</strong></div>
  </div>

  <!-- GRAFİK TARİH ARALIĞI -->
  <div class="controls">
    <strong>Grafik Tarih Aralığı:</strong><br><br>
    <input type="date" id="chartStart" />
    <input type="date" id="chartEnd" />
    <button onclick="updateChart()">Hesapla</button>
  </div>

  <canvas id="lineChart" height="120"></canvas>

  <div class="summary">
    <strong>Seçilen Tarih Aralığı Özeti</strong><br><br>
    Kazanç / Kayıp: <span id="chartDiff">-</span><br>
    Yüzde: <span id="chartPct">-</span><br>
    Nakit Çıkışı: <span id="chartCash">-</span>
  </div>
</div>

<script>
let data = JSON.parse(localStorage.getItem('financeData') || '[]');

function format(n){ return n.toLocaleString('tr-TR') }

function calculateRange(start, end){
  let filtered = data.filter(d => d.date >= start && d.date <= end);
  if(filtered.length < 2) return null;
  let first = filtered[0].value;
  let last = filtered[filtered.length-1].value;
  let cash = filtered.reduce((s,d)=> s + (d.cashOut||0),0);
  return { diff:last-first, pct:((last-first)/first)*100, cash, last };
}

function calculateTopRange(){
  let preset = document.getElementById('presetRange').value;
  let end = new Date();
  let start;
  if(preset !== 'custom'){
    start = new Date();
    start.setDate(end.getDate()-Number(preset));
  } else {
    start = new Date(document.getElementById('topStart').value);
    end = new Date(document.getElementById('topEnd').value);
  }
  let res = calculateRange(start.toISOString().slice(0,10), end.toISOString().slice(0,10));
  if(!res) return;
  document.getElementById('lastValue').innerText = format(res.last);
  document.getElementById('rangeDiff').innerText = format(res.diff);
  document.getElementById('rangePct').innerText = res.pct.toFixed(2)+'%';
  document.getElementById('rangeCash').innerText = format(res.cash);
}

let ctx = document.getElementById('lineChart');
let chart = new Chart(ctx,{
  type:'line',
  data:{ labels:[], datasets:[{ label:'Toplam Değer', data:[], tension:.3 }] },
  options:{ responsive:true }
});

function updateChart(){
  let s = document.getElementById('chartStart').value;
  let e = document.getElementById('chartEnd').value;
  let filtered = data.filter(d => d.date >= s && d.date <= e);
  if(filtered.length < 2) return;
  chart.data.labels = filtered.map(d=>d.date);
  chart.data.datasets[0].data = filtered.map(d=>d.value);
  chart.update();
  let res = calculateRange(s,e);
  document.getElementById('chartDiff').innerText = format(res.diff);
  document.getElementById('chartPct').innerText = res.pct.toFixed(2)+'%';
  document.getElementById('chartCash').innerText = format(res.cash);
}
</script>
</body>
</html>
